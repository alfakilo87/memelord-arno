---
apiVersion: secretgenerator.mittwald.de/v1alpha1
kind: StringSecret
metadata:
  name: {{ .Release.Name }}-redis
spec:
  fields:
    - fieldName: redis-password
      length: "32"
      encoding: hex
---
apiVersion: secretgenerator.mittwald.de/v1alpha1
kind: StringSecret
metadata:
  name: {{ .Release.Name }}-django
spec:
  fields:
    - fieldName: secret-key
      length: "64"
      encoding: hex
---
apiVersion: v1
kind: Service
metadata:
  name: minio
  namespace: {{ .Release.Namespace }}
spec:
  type: ExternalName
  externalName: minio.minio.svc.cluster.local
---
apiVersion: dragonflydb.io/v1alpha1
kind: Dragonfly
metadata:
  name: {{ .Release.Name }}-redis
spec:
  authentication:
    passwordFromSecret:
      name: {{ .Release.Name }}-redis
      key: redis-password
  replicas: 1
  resources:
    requests:
      cpu: 500m
      memory: 500Mi
    limits:
      cpu: 600m
      memory: 750Mi
---
apiVersion: secretgenerator.mittwald.de/v1alpha1
kind: StringSecret
metadata:
  name: {{ .Release.Name }}-database
  labels:
    cnpg.io/reload: "true"
spec:
  data:
    username: {{ .Release.Name }}
  fields:
    - fieldName: password
      length: "32"
      encoding: hex
---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: {{ .Release.Name }}-database
spec:
  instances: 1
  imageName: ghcr.io/cloudnative-pg/postgresql:17
  storage:
    size: 1Gi
    storageClass: postgres
  affinity:
    podAntiAffinityType: required
    nodeSelector:
      codemowers.io/lvm-ubuntu-vg: enterprise-ssd
  resources:
    requests:
      cpu: "100m"
      memory: "1Gi"
    limits:
      cpu: "1"
      memory: "4Gi"
  postgresql:
    parameters:
      max_connections: "300"
      shared_buffers: "512MB"
      effective_cache_size: "2GB"
  managed:
    roles:
    - name: {{ .Release.Name }}
      ensure: present
      login: true
      passwordSecret:
        name: {{ .Release.Name }}-database
---
apiVersion: postgresql.cnpg.io/v1
kind: Database
metadata:
  name: {{ .Release.Name }}
spec:
  name: {{ .Release.Name }}
  owner: {{ .Release.Name }}
  cluster:
    name: {{ .Release.Name }}-database
---
apiVersion: s3.onyxia.sh/v1alpha1
kind: Policy
metadata:
  name: {{ .Release.Name }}-policy
spec:
  name: {{ .Release.Name }}-policy
  s3InstanceRef: minio/default
  policyContent: >-
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": [
            "s3:ListBucket",
            "s3:GetObject",
            "s3:PutObject",
            "s3:HeadObject"
          ],
          "Resource": [
            "arn:aws:s3:::{{ .Release.Name }}",
            "arn:aws:s3:::{{ .Release.Name }}/*"
          ]
        }
      ]
    }
---
apiVersion: s3.onyxia.sh/v1alpha1
kind: S3User
metadata:
  name: {{ .Release.Name }}-bucket
spec:
  accessKey: {{ .Release.Name }}-bucket
  policies:
    - {{ .Release.Name }}-policy
  s3InstanceRef: minio/default
---
apiVersion: s3.onyxia.sh/v1alpha1
kind: Bucket
metadata:
  name: {{ .Release.Name }}
spec:
  name: {{ .Release.Name }}
  s3InstanceRef: minio/default
  quota:
    default: 100000000
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}
  namespace: {{ .Release.Namespace }}
spec:
  replicas: {{ .Values.replicas | default 1 }}
  selector:
    matchLabels:
      app: memelord
  template:
    metadata:
      labels:
        app: memelord
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 33
        runAsGroup: 33
      containers:
        - name: memelord
          image: ghcr.io/l4rm4nd/memelord:latest
          imagePullPolicy: Always
          securityContext:
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
          ports:
            - name: http
              containerPort: 8000
          env:
            - name: DOMAIN
              value: "{{ .Values.hostname }},localhost,127.0.0.1"
            - name: DEBUG
              value: "False"
            - name: DJANGO_LOG_LEVEL
              value: "INFO"
            - name: SECURE_COOKIES
              value: "True"
            - name: SESSION_COOKIE_AGE
              value: "30"
            - name: SESSION_EXPIRE_AT_BROWSER_CLOSE
              value: "False"
            - name: TZ
              value: "Europe/Tallinn"
            - name: ENABLE_PUBLIC_FEED
              value: "False"
            - name: MAX_UPLOAD_SIZE_MB
              value: "10"
            - name: SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-django
                  key: secret-key
            - name: OIDC_ENABLED
              value: "True"
            - name: OIDC_AUTOLOGIN
              value: "False"
            - name: OIDC_CREATE_USER
              value: "True"
            - name: OIDC_RP_SIGN_ALGO
              value: "RS256"
            - name: OIDC_RP_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: oidc-client-{{ .Release.Name }}-owner-secrets
                  key: OIDC_CLIENT_ID
            - name: OIDC_RP_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: oidc-client-{{ .Release.Name }}-owner-secrets
                  key: OIDC_CLIENT_SECRET
            - name: OIDC_OP_AUTHORIZATION_ENDPOINT
              value: "https://auth.ee-lte-1.codemowers.io/auth"
            - name: OIDC_OP_TOKEN_ENDPOINT
              value: "http://passmower.passmower/token"
            - name: OIDC_OP_USER_ENDPOINT
              value: "http://passmower.passmower/me"
            - name: OIDC_OP_JWKS_ENDPOINT
              value: "http://passmower.passmower/jwks"
            - name: DB_ENGINE
              value: "postgres"
            - name: POSTGRES_HOST
              value: "{{ .Release.Name }}-database-rw"
            - name: POSTGRES_PORT
              value: "5432"
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-database-app
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-database-app
                  key: password
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-database-app
                  key: dbname
            - name: REDIS_HOST
              value: "{{ .Release.Name }}-redis"
            - name: REDIS_PORT
              value: "6379"
            - name: REDIS_DB
              value: "0"
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-redis
                  key: redis-password
            - name: STORAGE_BACKEND
              value: "s3"
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-bucket
                  key: accessKey
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-bucket
                  key: secretKey
            - name: AWS_STORAGE_BUCKET_NAME
              value: "{{ .Release.Name }}"
            - name: AWS_S3_REGION_NAME
              value: "ee-lte-1"
            - name: AWS_S3_CUSTOM_DOMAIN
              value: "minio.ee-lte-1.codemowers.io/{{ .Release.Name }}"
            - name: AWS_S3_ENDPOINT_URL
              value: "http://minio:9000"
            - name: AWS_DEFAULT_ACL
              value: "private"
            - name: AWS_QUERYSTRING_AUTH
              value: "True"
            - name: AWS_S3_FILE_OVERWRITE
              value: "False"
            - name: AWS_LOCATION
              value: "media"
          volumeMounts:
            - name: logs
              mountPath: /opt/app/logs
            - name: media
              mountPath: /opt/app/media
            - name: static
              mountPath: /opt/app/myapp/static
            - name: settings
              mountPath: /opt/app/myproject/settings.py
              subPath: settings.py
      volumes:
        - name: logs
          emptyDir: {}
        - name: media
          emptyDir: {}
        - name: static
          emptyDir: {}
        - name: settings
          configMap:
            name: settings
---
apiVersion: v1
kind: Service
metadata:
  name: memelord
  namespace: {{ .Release.Namespace }}
spec:
  type: ClusterIP
  selector:
    app: memelord
  ports:
    - name: http
      port: 80
      targetPort: 8000
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: {{ .Release.Name }}
  namespace: {{ .Release.Namespace }}
spec:
  secretName: {{ .Release.Name }}-tls
  dnsNames:
    - {{ .Values.hostname }}
  issuerRef:
    name: letsencrypt
    kind: ClusterIssuer
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ .Release.Name }}
  namespace: {{ .Release.Namespace }}
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
spec:
  ingressClassName: traefik
  rules:
    - host: {{ .Values.hostname }}
      http:
        paths:
          - pathType: Prefix
            path: "/"
            backend:
              service:
                name: memelord
                port:
                  number: 80
  tls:
    - secretName: {{ .Release.Name }}-tls
---
apiVersion: codemowers.cloud/v1beta1
kind: OIDCClient
metadata:
  name: {{ .Release.Name }}
  namespace: {{ .Release.Namespace }}
spec:
  displayName: Memelord {{ .Release.Name }}
  uri: https://{{ .Values.hostname }}/
  redirectUris:
    - https://{{ .Values.hostname }}/oidc/callback/
  grantTypes:
    - authorization_code
    - refresh_token
  responseTypes:
    - code
  availableScopes:
    - openid
    - profile
  pkce: false
